<meta charset="utf-8">
<div class="row">
	<div class="col-xs-12">
		<div class="box">
			<div class="box-header">
				<h3 class="box-title">图书资料维护</h3>

				<div class="box-tools">
					<div class="input-group input-group-sm" style="width: 350px;">
						<input type="text" name="table_search" id="serchNameId"
							class="form-control pull-right" placeholder="文件名查询">
						<div class="input-group-btn">
							<button type="button" class="btn btn-default btn-search">
								<i class="fa fa-search"></i>
							</button>
							<button type="submit" class="btn btn-default btn-register">添加</button>
							<button type="submit" class="btn btn-default btn-delete">删除</button>
<!--							<button type="submit" class="btn btn-default btn-update">修改</button>-->
						</div>
					</div>
				</div>
			</div>
			<!-- /.box-header -->
			<div class="box-body table-responsive no-padding">
				<table class="table table-hover">
					<thead>
						<tr>
							<th>选择</th>
							<th>资源名称</th>
							<th>类型</th>
							<th>服务器资源路径</th>
							<th>百度云地址</th>
						</tr>
					</thead>
					<tbody id="tbody">
					</tbody>
				</table>
			</div>
			<div id="pageId" class="box-footer clearfix">
				<ul class="pagination pagination-sm no-margin pull-left">
					<li><a class="first">首页</a></li>
					<li><a class="pre">上一个</a></li>
					<li><a class="next">下一个</a></li>
					<li><a class="last">尾页</a></li>
					<li><a class="rowCount">总记录数(9)</a></li>
					<li><a class="pageCount">总页数(3)</a></li>
					<li><a class="pageCurrent">当前页数(1)</a></li>
				</ul>
			</div>
		</div>
	</div>
</div>

<div class="m-modal">
	<div class="m-modal-dialog">
		<div class="m-top">
			<h4 class="m-modal-title">
				删除
			</h4>
			<span class="m-modal-close">&times;</span>
		</div>
		<div class="m-middle">
			<!--content-->
			<p>确认删除么</p>

		</div>
		<div class="m-bottom">
			<button class="m-btn-sure">确定</button>
			<button class="m-btn-cancel">取消</button>
		</div>
	</div>
</div>

<script type="text/javascript">
	$(function() {
		doFindObjects();
		$(".input-group-btn").on("click", ".btn-delete", doDeleteObject);
		$(".input-group-btn").on("click", ".btn-register",doRegisteObject);
		// $(".input-group-btn").on("click", ".btn-update",doUpdateObject);
		$(".input-group-btn").on("click", ".btn-search", doQueryObject);
		$(".clearfix").on("click", ".first,.pre,.next,.last", doJumpToPage);
	});

	function setPagination(pageObject) {
		$(".rowCount").html("总记录数(" + pageObject.rowCount + ")");
		$(".pageCount").html("总页数(" + pageObject.pageCount + ")");
		$(".pageCurrent").html("当前页(" + pageObject.pageCurrent + ")");

		$("#pageId").data("pageCurrent", pageObject.pageCurrent);
		$("#pageId").data("pageCount", pageObject.pageCount);
	}

	/**分页页面跳转*/
	function doJumpToPage() {
		var pageCurrent = $("#pageId").data("pageCurrent");
		var pageCount = $("#pageId").data("pageCount");
		var cls = $(this).prop("class");
		//console.log(cls);
		if (cls === "first") {
			pageCurrent = 1;
		}
		if (cls === "pre" && pageCurrent > 1) {
			pageCurrent--;
		}
		if (cls === "next" && pageCurrent < pageCount) {
			pageCurrent++;
		}
		if (cls === "last") {
			pageCurrent = pageCount;
		}		
		$("#pageId").data("pageCurrent",pageCurrent);
		doFindObjects();
	}

	function doFindObjectByNameType() {
		var pageCurrent = $("#pageId").data("pageCurrent");
		if(!pageCurrent) pageCurrent = 1;
		var params = {
			"pageCurrent" :pageCurrent,
			"type": 1,
		};
		var url = "data/get/getDataByNameType.do";

		params.filename = $("#serchNameId").val();
		// var typeInt = $("#serchTypeId").val();
		// if (typeInt === "pdf") {
		// 	params.type = 1;
		// } else {
		// 	params.type = 2;
		// }
		console.log(params);
		$.getJSON(url, params, function(result) {
			if(result.state === 1) {
				//显示数据
				doSetTableBody(result.data.records);
				//设置分页
				console.log(result.data);
				setPagination(result.data);
			}else{
				alert(result.message);
			}
		});
	}

	/**根据用户名查找信息*/
	function doQueryObject() {
		$("#pageId").data("pageCurrent",1);
		doFindObjectByNameType();
	}
	// function FindTableRow() {
	// 	// var data = [];
	// 	//
	// 	// $("table tbody tr").find(":checkbox:checked").each(function () {
	// 	// 	var val = $(this).parent("td").parent("tr").children().get();
	// 	// 	data.push(val);
	// 	// 	console.log(val);
	// 	// });
	// 	return data;
	// }
	/**更新操作*/
	function doUpdateObject() {
		var title;
		if ($(this).hasClass("btn-update")) {
			title = "修改文件";
			var ids = getCheckedIds();
			if (ids.length === 0 || ids.length > 1) {
				alert("请选择一个进行修改");
				return;
			}

		}
		var colData = [];
		$("tr>td input[type='checkbox']:checked").each(function () {
			var td_tag = $(this).parent().siblings();
			for (var i = 0; i < td_tag.length; i++) {
				colData[i] = $(this).parent().siblings("td:eq(" + i + ")").text();
			}
		});

		var data = {
			id: getCheckedIds()[0],
			content: colData[0],
			type: colData[1],
			address: colData[2],
			baiduyun: colData[3],
		};

		console.log("data",data);
		$("#Mycontent").load("data/updateUI.do", function() {
			$(".box-title").html(title);
			$("#Mycontent").data("data",data);
		});
	}
	/**注册操作*/
	function doRegisteObject() {
		//alert("doRegisteObject");
		var title;
		if ($(this).hasClass("btn-register")) {
			title = "添加文件";
		}

		$("#Mycontent").load("data/saveUI.do", function() {
			$(".box-title").html(title);
		});
	}

	/**角色的删除操作*/
	function doDeleteObject() {
		var m1 = new MyModal.modal(function() {
			//alert("doDeleteObject");
			var checkedIds = getCheckedIds();
			//console.log("doDeleteObject().checkIds:"+checkedIds);
			if (checkedIds.length === 0) {
				alert("请选择需要删除的内容，谢谢！");
				return;
			}
			var url = "data/doDelByID.do";
			var params = {
				"checkedIds" : checkedIds.toString()
			}

			// console.log(params);
			$.post(url, params, function(result) {
				if(result.state === 1){
					alert("删除成功！");
					doFindObjects();
				}else{
					alert(result.message);
				}
			});
		});
		m1.show()

	}
	/**获取选中角色列表中的记录*/
	function getCheckedIds() {
		// console.log("getCheckedIds(),start!")
		var checkedIds = [];
		$("tbody input[name='checkedId']").each(function() {
			if ($(this).prop("checked")) {
				checkedIds.push($(this).val());
			}
		});
		//console.log(checkedIds);
		return checkedIds;
	}
	/**从服务器端获取对象*/
	function doFindObjects() {
		var pageCurrent = $("#pageId").data("pageCurrent");
		if(!pageCurrent) pageCurrent = 1;
		var params = {
			"pageCurrent" :pageCurrent
		};
		var url = "data/get/getDataByPages.do";
		params.name = $("#serchNameId").val();
		console.log(params);
		$.getJSON(url, params, function(result) {
			if(result.state === 1){
			//显示数据
			doSetTableBody(result.data.records);
			//设置分页
			console.log(result.data);
			setPagination(result.data);
			}else{
				alert(result.message);
			}
		});
	}
	/**将数据添加到动态表格里*/
	function doSetTableBody(data) {
		var tbody = $("#tbody");
		tbody.empty();
		for ( var i in data) {
			var tr = $("<tr></tr>");
			var type = data[i].type;

			if (type === 1) {
				type = "pdf";
			} else if (type === 2) {
				type = "doc";
			}

			tr.data("id",data[i].id);
			tr.append("<td><input type='checkbox' name='checkedId' value='"+data[i].id+"'></td>");
			tr.append("<td>" + data[i].content + "</td>");
			tr.append("<td>" + type + "</td>");
			tr.append("<td>" + data[i].address + "</td>");
			tr.append("<td>" + data[i].baiduyun + "</td>");
			tbody.append(tr);
		}
	}
</script>